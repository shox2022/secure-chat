<!DOCTYPE html>
<html>
<body>
  <h2>Secure Chat (ECDH + AES-GCM)</h2>
  <input id="msg" placeholder="Type message">
  <button onclick="send()">Send</button>
  <pre id="log"></pre>

  <script>
    const ws = new WebSocket("ws://localhost:8080");
    const log = document.getElementById("log");

    let ecdhKeyPair;
    let aesKey;

    (async () => {
      // 1️⃣ Generate client ECDH key pair
      ecdhKeyPair = await crypto.subtle.generateKey(
        { name: "ECDH", namedCurve: "P-256" },
        true,
        ["deriveKey"]
      );
      console.log("Client ECDH keys generated");
    })();

    ws.onmessage = async e => {
      const data = JSON.parse(e.data);

      // 2️⃣ Receive server public key
      if (data.type === "server-public-key") {
        console.log("Received server public key");

        const serverPub = await crypto.subtle.importKey(
          "raw",
          Uint8Array.from(atob(data.key), c => c.charCodeAt(0)),
          { name: "ECDH", namedCurve: "P-256" },
          false,
          []
        );

        // 3️⃣ Send client public key
        const clientPubRaw = await crypto.subtle.exportKey("raw", ecdhKeyPair.publicKey);
        ws.send(JSON.stringify({
          type: "client-public-key",
          key: btoa(String.fromCharCode(...new Uint8Array(clientPubRaw)))
        }));

        // 4️⃣ Derive AES key from shared secret
        aesKey = await crypto.subtle.deriveKey(
          { name: "ECDH", public: serverPub },
          ecdhKeyPair.privateKey,
          { name: "AES-GCM", length: 256 },
          false,
          ["encrypt", "decrypt"]
        );

        console.log("Shared AES key established (client)");
      }

      // 5️⃣ Receive decrypted/echoed messages from server
      if (data.type === "chat") {
        log.textContent += "Server says: " + data.text + "\n";
      }
    };

    // 6️⃣ Send AES-encrypted chat message
    async function send() {
      if (!aesKey) {
        alert("AES key not ready yet");
        return;
      }

      const plaintext = document.getElementById("msg").value;
      const encoder = new TextEncoder();
      const encoded = encoder.encode(plaintext);

      const iv = crypto.getRandomValues(new Uint8Array(12));

      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        aesKey,
        encoded
      );

      // AES-GCM automatically appends 16-byte auth tag at the end
      const tagLength = 16;
      const ciphertextBytes = new Uint8Array(ciphertext);
      const tag = ciphertextBytes.slice(ciphertextBytes.length - tagLength);
      const ct = ciphertextBytes.slice(0, ciphertextBytes.length - tagLength);

      ws.send(JSON.stringify({
        type: "chat",
        iv: btoa(String.fromCharCode(...iv)),
        data: btoa(String.fromCharCode(...ct)),
        tag: btoa(String.fromCharCode(...tag))
      }));

      document.getElementById("msg").value = "";
    }
  </script>
</body>
</html>
